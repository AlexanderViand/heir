// RUN: heir-opt --new-layout-propagation --fold-convert-layout-into-assign-layout %s | FileCheck %s

// CHECK-DAG: #kernel = #secret.kernel<name = "MatvecDiagonal", force = false>
// CHECK-DAG: #[[rm_layout1:.*]] = #tensor_ext.new_layout<"{ [i0] -> [ct, slot] : ct = 0 and (-i0 + slot) mod 16 = 0 and 0 <= i0 <= 9 and 0 <= slot <= 1023 }">
// CHECK-DAG: #[[rm_layout:.*]] = #tensor_ext.new_layout<"{ [i0] -> [ct, slot] : ct = 0 and (-i0 + slot) mod 16 = 0 and 0 <= i0 <= 15 and 0 <= slot <= 1023 }">
// CHECK: @matvec
// CHECK-SAME: %[[arg0:.*]]: !secret.secret<tensor<16xf32>> {tensor_ext.layout = #[[rm_layout]]}) ->
func.func @matvec(%arg0: !secret.secret<tensor<16xf32>>) -> !secret.secret<tensor<10xf32>> {
  %cst = arith.constant dense<0.000000e+00> : tensor<10xf32>
  // CHECK: %[[bias:.*]] = arith.constant dense<0.00
  // CHECK: %[[cst:.*]] = arith.constant
  // CHECK-SAME: tensor<10x16xf32>

  // Assign a layout to the matrix and bias
  // CHECK-DAG: tensor_ext.assign_layout %[[cst]]
  // CHECK-DAG: tensor_ext.assign_layout %[[bias]]
  %cst_0 = arith.constant dense<"0x5036CB3DED693F3E647E8E3F1C7029BFBEE1923F83F258BE77DDA1BFD7EDB93C309239C0842D833EB0C3163FD1DB2ABF5D971B3F1091853EED900CBE19464BBFE147C3BE584F72BF27116D3DAA05383F32109FBFC956703FADE2DCBEEE8F443E3EF9903F90A07CBF7803133FCDB2E83EDC29103FCC190A3FECD986BFAE4E853DE4A9393E3CB9E83EBA00FA3D0DBFF0BE79DF193F4E00073F29DA10BE1C9693BD12360BBFEEFCFBBD051EBDBEAE500E3F598190BF369C0D3F65AB74BF022E55BE47C021BEBD0E8D3EDDD4C93EBF82CB3F726237BFE1645E3FA4569FBDB0863BBFD15A1FC097BE063E94A451BFE4AA0B3F0C8726BEA2AD41BE1A15F63E1CDB073F40F376BF4D87BDBEA96AA03E8D9F843DBF6FFB3F9C8203BF24B92ABE7F70C5BE733F6C3F7CE7DA3E1F83C13F0284113EF339193F1B19E13CA1F5FA3E6E31C9BEA1078D3E5A0439BF1FD4A7BE3640A63F55B69FBF6D8B66BD4DF072BFC166A93E8D4BDF3FBF4AEABD9FD976BFB809763ECD4C10BFC88265BF6B2BABBEC202C5BE8D53EB3DBE94AABE3C3297BD75BF7FBE1EFEF83E1936893FAE8AA13EAF6CACBD615C2DC0473F593FE32D25BFDF71D0BD382D6CBE2DD392BD9C4FECB84BF853BED6E0493ECDCA91BE387D02BFF615053D7D4EB63F0042113E4C661B3FBF5F023F83868D3F497814BD911CAB3F4BC424BE7A020C3F6509A73E95E499BEEE54DB3EEFFC3CBF695FA93EA695923E1937CB3F553A37BF6EC745BF3DCF823EEC98153FC2D49C3F8523E03D07ED413D13E9853E016DA2BED73A6F3E2D0268BEEBC9613EBEB947BE870B93BE3402CB3EC68B41BE50F054BF161EB23E4FDC1F3EB562A1BDD9A115C0CCA8D6BDD65AFDBED757033F590DF63EC4280CBF8EA7EABE74C317BE"> : tensor<10x16xf32>
  %0 = secret.generic(%arg0 : !secret.secret<tensor<16xf32>>) {
  ^body(%input0: tensor<16xf32>):
    // CHECK: linalg.matvec
    // CHECK-SAME: secret.kernel = #kernel
    %1 = linalg.matvec ins(%cst_0, %input0 : tensor<10x16xf32>, tensor<16xf32>) outs(%cst : tensor<10xf32>) -> tensor<10xf32>
    secret.yield %1 : tensor<10xf32>
    // CHECK: secret.yield
    // CHECK-NEXT: -> (!secret.secret<tensor<10xf32>> {tensor_ext.layout = #[[rm_layout1]]})
  } -> !secret.secret<tensor<10xf32>>
  return %0 : !secret.secret<tensor<10xf32>>
}
